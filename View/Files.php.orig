<?php

namespace Skinny\View;

class Files implements \IteratorAggregate {
    
    protected $_filesPath = null;
    protected $_extension = null;
    protected $_baseUrl = null;
    
    protected $_items = [];
<<<<<<< HEAD
=======
    protected $_index = [];
>>>>>>> Bardzo szczątkowo - rozpoczęcie prac nad View
    
    /**
     * Umożliwia iterowanie bezpośrednio po elementach tablicy $_items.
     * 
     * @return ArrayIterator
     */
    public function getIterator() {
        return new \ArrayIterator($this->_items);
    }
    
    /**
     * Konstruktor kolekcji plików.
     * 
     * @param string $path Ścieżka do katalogu głównego z plikami
     * @param string $extension Rozszerzenie plików (np. ".js")
     * @throws Exception
     */
    public function __construct($baseUrl, $path, $extension) {
<<<<<<< HEAD
        if(empty($path) || !is_string($path)) {
            throw new Exception('Argument $path is invalid');
        }
        if(empty($extension) || !is_string($extension)) {
            throw new Exception('Argument $extension is invalid');
        }
        if(empty($baseUrl) || !is_string($baseUrl)) {
            throw new Exception('Argument $baseUrl is invalid');
        }
        
        if($extension[0] !== '.') {
            $extension = '.' + $extension;
=======
        if(empty($baseUrl) || !is_string($baseUrl)) {
            throw new Exception('Argument $baseUrl (' . $baseUrl . ') is invalid');
        }
        if(empty($path) || !is_string($path)) {
            throw new Exception('Argument $path (' . $path . ') is invalid');
        }
        if(empty($extension) || !is_string($extension)) {
            throw new Exception('Argument $extension (' . $extension . ') is invalid');
>>>>>>> Bardzo szczątkowo - rozpoczęcie prac nad View
        }
        
        $this->_filesPath = $path;
        $this->_extension = $extension;
        $this->_baseUrl = $baseUrl;
    }
    
    
    /**
     * Dodaje plik do kolekcji.
     * 
     * @param string $file
<<<<<<< HEAD
     * @param boolean $checkFileExistance
=======
     * @param boolean $checkFileExistance Wymusza sprawdzenie istnienia pliku
>>>>>>> Bardzo szczątkowo - rozpoczęcie prac nad View
     * @return \Skinny\View\Files
     * @throws Exception
     */
    public function add($file, $checkFileExistance = false) {
        $filePath = $this->_getFilePath($file);
        
        if($checkFileExistance) {
            if(!file_exists($filePath)) {
                throw new Exception("File $filePath doesn't exist");
            }
        }
        
<<<<<<< HEAD
        $this->_items[$file] = $filePath;
=======
        $this->_items[] = $filePath;
        $this->_index[$file] = &$this->_items[count($this->_items) - 1];
        
        return $this;
    }
    
    /**
     * Dodaje plik na początku.
     * @param string $file
     * @param voolean $checkFileExistance
     * @return \Skinny\View\Files
     * @throws Exception
     */
    public function addFirst($file, $checkFileExistance = false) {
        $filePath = $this->_getFilePath($file);
        
        if($checkFileExistance) {
            if(!file_exists($filePath)) {
                throw new Exception("File $filePath doesn't exist");
            }
        }
        
        array_unshift($this->_items, $filePath);
        $this->_index[$file] = &$this->_items[0];
>>>>>>> Bardzo szczątkowo - rozpoczęcie prac nad View
        
        return $this;
    }
    
    /**
<<<<<<< HEAD
     * Konfiguruje i zwraca ścieżkę do wybranego pliku.
=======
     * Konfiguruje i zwraca pełną ścieżkę (absolutną lub url) do wybranego pliku.
>>>>>>> Bardzo szczątkowo - rozpoczęcie prac nad View
     * 
     * @param string $file
     * @return string
     */
    protected function _getFilePath($file) {
        if(!\Skinny\Path::isAbsolute($file) && !\Skinny\Url::hasProtocol($file)) {
            // należy dokleić ścieżkę do plików JS w momencie gdy adres pliku nie jest
            // absolutny i nie jest też urlem
            $file = \Skinny\Path::combine($this->_baseUrl, $this->_filesPath, $file);
        }
        
        return $file . $this->_extension;
    }
    
    /**
     * Usuwa wybrany plik z kolekcji.
     * 
     * @param string $file
     * @return \Skinny\View\Files
     */
    public function remove($file) {
<<<<<<< HEAD
        if(isset($this->_items[$file])) {
            unset($this->_items[$file]);
=======
        if(isset($this->_index[$file])) {
            unset($this->_index[$file]);
>>>>>>> Bardzo szczątkowo - rozpoczęcie prac nad View
        }
        
        return $this;
    }
}
